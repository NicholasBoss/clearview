<div class="account-container">
    <h1>My Account</h1>

    <div class="account-actions">
        <a href="/orders/create" class="btn-primary">Create New Order</a>
        <!-- if admin or dba, add button for admin view of orders -->
        <% if (locals.accountData && (locals.accountData.account_type === 'Admin' || locals.accountData.account_type === 'DBA')) { %>
            <a href="/admin/orders" class="btn-primary">Admin Orders View</a>
        <% } %>
    </div>

    <h2>My Orders</h2>

    <% if (orders && orders.length > 0) { %>
        <div class="filter-container" style="margin-bottom: 1rem; display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
            <div>
                <label for="customerFilter" style="margin-right: 0.5rem;"><b>Filter by Customer:</b></label>
                <select id="customerFilter" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="">All Customers</option>
                    <% customers.forEach(customer => { %>
                        <option value="<%= customer.customer_id %>">
                            <%= customer.customer_lastname %>, <%= customer.customer_firstname %>
                        </option>
                    <% }) %>
                </select>
            </div>
            <div>
                <label style="margin-right: 0.5rem;"><b>Filter by Status:</b></label>
                <label style="margin-right: 1rem;">
                    <input type="checkbox" id="filterEstimate" checked> Needs Confirmation
                </label>
                <label style="margin-right: 1rem;">
                    <input type="checkbox" id="filterConfirmed" checked> Confirmed
                </label>
                <label style="margin-right: 1rem;">
                    <input type="checkbox" id="filterCompleted"> Completed
                </label>
                <label>
                    <input type="checkbox" id="filterCancelled"> Cancelled
                </label>
            </div>
        </div>

        <div class="orders-table-container">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Customer</th>
                        <th>Details</th>
                        <th>Date Created</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(order => {
                        // Determine order status for filtering
                        let orderStatus = 'pending';
                        if (order.is_cancelled) {
                            orderStatus = 'cancelled';
                        } else if (order.is_completed) {
                            orderStatus = 'completed';
                        } else if (order.is_confirmed) {
                            orderStatus = 'confirmed';
                        } else if (order.is_estimate) {
                            orderStatus = 'estimate';
                        }
                    %>
                        <tr data-customer-id="<%= order.customer_id || '' %>" data-status="<%= orderStatus %>">
                            <td class="product-name"><%= order.product_name %></td>
                            <td class="customer-name">
                                <% if (order.customer_firstname && order.customer_lastname) { %>
                                    <%= order.customer_lastname %>, <%= order.customer_firstname %>
                                <% } else { %>
                                    N/A
                                <% } %>
                            </td>
                            <td class="order-details">
                                <% if (order.mirage_3500_handle) { %>
                                    Handle: <%= order.mirage_3500_handle %>
                                <% } else if (order.mirage_build_out) { %>
                                    Build Out: <%= order.mirage_build_out %>
                                <% } else { %>
                                    Order #<%= order.customization_id %>
                                <% } %>
                            </td>
                            <td class="order-date">
                                <% if (order.order_date) { %>
                                    <%= new Date(order.order_date).toLocaleDateString() %>
                                <% } else { %>
                                    N/A
                                <% } %>
                            </td>
                            <td class="order-status">
                                <% if (order.is_cancelled) { %>
                                    <span class="status-badge status-cancelled">Cancelled</span>
                                <% } else if (order.is_completed) { %>
                                    <span class="status-badge status-completed">Completed</span>
                                <% } else if (order.is_confirmed) { %>
                                    <span class="status-badge status-confirmed">Confirmed</span>
                                <% } else if (order.is_estimate) { %>
                                    <span class="status-badge status-estimate">Needs Confirmation</span>
                                <% } else { %>
                                    <span class="status-badge status-pending">Pending</span>
                                <% } %>
                            </td>
                            <td class="order-actions">
                                <%
                                    // Determine URL paths based on product type
                                    let productUrlName = '';
                                    switch(order.product_name) {
                                        case 'Mirage 3500':
                                            productUrlName = 'Mirage3500';
                                            break;
                                        case 'Mirage':
                                            productUrlName = 'Mirage';
                                            break;
                                        case 'Rainier':
                                            productUrlName = 'Rainier';
                                            break;
                                        case 'NWS':
                                            productUrlName = 'NWS';
                                            break;
                                        default:
                                            productUrlName = null;
                                    }
                                %>
                                <% if (productUrlName) { %>
                                    <% if (order.is_estimate && !order.is_confirmed) { %>
                                        <a href="/orders/edit<%= productUrlName %>/<%= order.customization_id %>" class="btn-action btn-confirm">Confirm</a>
                                    <% } %>
                                    <a href="/orders/view<%= productUrlName %>/<%= order.customization_id %>" class="btn-action btn-view">View Details</a>
                                    <% if (order.is_confirmed && !order.is_completed && !order.is_cancelled) { %>
                                        <form action="/orders/complete<%= productUrlName %>/<%= order.customization_id %>" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to mark this order as complete?');">
                                            <button type="submit" class="btn-action btn-complete">Complete Order</button>
                                        </form>
                                    <% } %>
                                <% } else { %>
                                    <span style="color: #999; font-style: italic;">Order #<%= order.customization_id %></span>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <div class="no-orders">
            <p>You don't have any orders yet.</p>
            <p><a href="/orders/create">Create your first order</a></p>
        </div>
    <% } %>
</div>

<% if (orders && orders.length > 0) { %>
<script>
    // Combined filter functionality
    function applyFilters() {
        const selectedCustomerId = document.getElementById('customerFilter').value;
        const showEstimate = document.getElementById('filterEstimate').checked;
        const showConfirmed = document.getElementById('filterConfirmed').checked;
        const showCompleted = document.getElementById('filterCompleted').checked;
        const showCancelled = document.getElementById('filterCancelled').checked;

        const rows = document.querySelectorAll('.orders-table tbody tr');

        rows.forEach(row => {
            const rowCustomerId = row.getAttribute('data-customer-id');
            const rowStatus = row.getAttribute('data-status');

            // Check customer filter
            const customerMatch = selectedCustomerId === '' || rowCustomerId === selectedCustomerId;

            // Check status filter
            let statusMatch = false;
            if (rowStatus === 'estimate' && showEstimate) statusMatch = true;
            if (rowStatus === 'confirmed' && showConfirmed) statusMatch = true;
            if (rowStatus === 'completed' && showCompleted) statusMatch = true;
            if (rowStatus === 'cancelled' && showCancelled) statusMatch = true;
            if (rowStatus === 'pending') statusMatch = true; // Always show pending

            // Show row only if both filters match
            if (customerMatch && statusMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Add event listeners
    document.getElementById('customerFilter').addEventListener('change', applyFilters);
    document.getElementById('filterEstimate').addEventListener('change', applyFilters);
    document.getElementById('filterConfirmed').addEventListener('change', applyFilters);
    document.getElementById('filterCompleted').addEventListener('change', applyFilters);
    document.getElementById('filterCancelled').addEventListener('change', applyFilters);

    // Apply filters on page load to hide completed orders by default
    applyFilters();
</script>
<% } %>