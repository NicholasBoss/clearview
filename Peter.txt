Some info:

10/29/25

Things added:

- Added form action towards confirmMirage3500.ejs in the createMirage3500 form
- Added a function to get measurements in the ordersModel.js file
- Updated the controller to pass fractions to the view in the ordersController.js file
- Added post routes to ordersRoute.js
- Created function for processing mirage3500 form in ordersController.js
- Rewrote the confirmMirage3500.ejs form to match the create order form 
- Created a final save route in ordersRoute.js
- Updated ordersModel to handle all the INSERT/SELECT logic for Mirage 3500
- Added new functions to exports in ordersModel.js
- Created controller function to handle final save in ordersController.js
- Added logic for handling measurements in the ordersModel

For validating form info
- Added ordersValidation.js
- Added routes for orders validation in ordersRoute
- Added changes to ordersController.js
- Made changes to createmirage3500.ejs
- Added error styling to createmirage3500.ejs


10/30/25

For dynamically adding form values from the database
- made changes to ordersModel.js
- made changes to ordersController.js
- removed hard coded colors from createmirage3500.ejs
- added changes to ordersValidation.js
- added placeholders to createMirage3500 form to tell us what data is used
- updated ordersController and ordersValidation in order to prevent redirect to confirm page when there are validation issues

CSS changes
- added an error banner rather than a bunch of bullet points 
- added more form styling and placeholders so that things are clearer

More stuff
- changed it so that the form data is saved in localStorage so the user doesn't have to redo everything

THIS BRANCH FROM THIS POINT FORWARD SHOULD NOT BE MERGED INTO DATABASE! (reminder for myself lol)



Things to change:

1. No SELECT * (all) statements
2. is_estimated should be checked true after create form is completed and the data should be inserted into the database so that it isn't lost 
3. is_confirmed should be checked true after confirm form is completed and if they are both checked true, the order is finalized and cannot be edited and can be viewed on the account page
4. Have a second confirm form that goes on the account page that cannot be edited (the one after the create form SHOULD be able to be edited) and will redirect to the original
5. Have data in localstorage so that the confirm page remembers what data was entered 
6. The account page will hold all of the orders so that the user can go back to them
7. There should be a pop up when the second submit button is clicked to make sure that they want to complete the order
8. Authentication is needed so that Gary can see every order, and have the orders soft deleted for everyone else (pass in the role that users are at when they log in)
9. Have an is_complete boolean flag, and if it is complete, soft delete the orders for all except the top admin (third check)
10. ONLY soft deletions unless order is for sure canceled (as an option for Gary the CEO, only)
11. Validate forms to make sure the correct kind of data is entered 


Process:
After the create form is created, is_estimated is checked true. After that, the confirm order is available, and is able to be edited, but not from the account page (the page will redirect to the original confirm page). Once the order is confirmed, an admin needs to mark is_completed as true. Gary, the CEO, can cancel the order at any time. is_estimated should be checked true after create form is completed and the data should be inserted into the database so that it isn't lost. is_confirmed should be checked true after confirm form is completed and if they are both checked true, the order is finalized and cannot be edited and can be viewed on the account page


What ------------ Who ------- Status ------ ... [if is_estimate = T && is_confirmed = F: CONFIRM, i_e = T && i_c = T: COMPLETE ORDER]
MIRAGE 3500      John Doe     Needs Conf    [CONFIRM] [VIEW ORDER DETAILS]
MIRAGE 3500      John Doe     Confirmed     [VIEW ORDER DETAILS] [COMPLETE ORDER]
MIRAGE 3500      John Doe     Completed     [VIEW ORDER DETAILS]

TO DO:

- start getting the customer information and add a customer input to the mirage3500 forms
- add hidden elements for sold and date sold on the forms 
- configure the orders to be filtered by customers
- incorporate customers into the forms and account page
- work on getting soft deletes to work 
- make sure user authentication is integrated (including for Gary specifically)
- change the popups to say data will be inserted after the create form is submitted and not when the confirm form is
- make sure there are popups before each action 
- Fix some of the form fields not populating after create form is submitted 

Things to Fix:

I found the root cause! The issue is with the database schema itself.

  The Problem:

  The code in saveMirage3500Data (ordersModel.js:679-697) correctly captures all these values:
  - handleColorId
  - topAdapterColorId
  - btmAdapterColorId
  - topAdapterId
  - btmAdapterId
  - rightBuildoutId
  - leftBuildoutId

  And retrieves mohair values, but the customization table schema is missing columns to store these values!

  Looking at the database schema (clearviewdb.sql:1219-1258), the customization table only has:
  - color_id - for the main color
  - top_adapter_width_id - for the adapter WIDTH (not the adapter type)
  - bottom_adapter_width_id - for the adapter WIDTH (not the adapter type)

  Missing columns:
  1. handle_color_id - to store handle color
  2. top_adapter_id - to store top adapter type
  3. top_adapter_color_id - to store top adapter color
  4. bottom_adapter_id - to store bottom adapter type
  5. bottom_adapter_color_id - to store bottom adapter color
  6. right_buildout_id - to store right buildout
  7. left_buildout_id - to store left buildout
  8. mohair_id - to store mohair type
  9. mohair_position_id - to store mohair position

  The Fix:

  I need to:
  1. Add these missing columns to the customization table (ALTER TABLE)
  2. Update the INSERT statement in saveMirage3500Data to include these values
  3. Update getOrderById to JOIN these new columns so the viewMirage3500 page can display them

  Should I proceed with adding these columns to the database schema? This will require running ALTER TABLE statements against your PostgreSQL database.

> I'm confused. Why can't you just query the handle_color table for the handle_color_id? Instead of having EVERYTHING in the customization table 

● You're absolutely right to question this! Let me look more carefully at the database structure to see if there are existing junction tables or relationships       
  I'm missing.

● You're making me think harder about the database architecture! I see there's a handle_color junction table, but I'm confused about how to link a specific
  order's handle color choice.

  The handle_color table links:
  - mirage_3500_id (the handle type)
  - product_color_id (the color)

  But in the code, mirage_3500_id is shared across all orders with the same handle type (line 673: getOrInsert on mirage_3500_handle). So if we just query the       
  handle_color table by mirage_3500_id, we might get colors from OTHER people's orders with the same handle type.

  My question: How should we link a specific customization/order to its unique color choices?

  Should we:
  1. Add handle_color_id, top_adapter_color_id, bottom_adapter_color_id columns to the customization table to store the foreign keys?
  2. Or is there a different architecture pattern I'm missing?

  The current code gets these IDs (lines 679-685) but never stores them anywhere, which is why they're lost when we try to retrieve the order later.

> Why not just use the same query for the view details page as the confirm page? They should basically just be the same page but the one from the account page       
should not be able to be edited. That's the only difference 

● You're absolutely right! That's a much simpler way to think about it. Both pages should display the same data - the confirm page just happens to be editable       
  and the view page is read-only.

● The problem is simple: in saveMirage3500Data (ordersModel.js), we're getting these IDs but never storing them in the database:

  - Lines 679-697: We call getOrInsert for handleColorId, topAdapterColorId, btmAdapterColorId, topAdapterId, btmAdapterId, rightBuildoutId, leftBuildoutId
  - Lines 837-898: The INSERT statement doesn't include any of these IDs!

  So when the confirm page gets data from session, it has everything. But when the view page queries the database, those values were never saved.

  Let me check what columns the customization table actually has available, then we can store these values properly:

● Read(database\inserted\clearviewdb.sql)
  ⎿  Read 45 lines

● The customization table is missing columns for these values! We need to add:

  - handle_color_id
  - top_adapter_id
  - top_adapter_color_id
  - bottom_adapter_id
  - bottom_adapter_color_id
  - right_buildout_id
  - left_buildout_id
  - mohair_id
  - mohair_position_id

  This would let us store the values we're already retrieving. Should I create an ALTER TABLE migration script to add these columns to the customization table? 

  Note for Nick:

  It's possible we need more stuff in the customization table. Many of the columns are not populating in the confirm form. Check lines 678-697 of ordersModel.js